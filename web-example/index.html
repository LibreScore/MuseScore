<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebMscore</title>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
    <script src="./node_modules/webmscore/webmscore.js"></script>
    <script type="module">
        // import WebMscore from './node_modules/webmscore/src/index.js'

        const name = 'Aequale_No_1.mscz'

        async function fetchFont(url) {
            const r = await fetch(url)
            const data = await r.arrayBuffer()
            return new Uint8Array(data)
        }

        WebMscore.ready.then(async () => {
            const r = await fetch(`./${name}`)
            const filedata = new Uint8Array(await r.arrayBuffer())

            const fonts = [
                await fetchFont("https://cdn.jsdelivr.net/gh/adobe-fonts/source-han-sans@release/SubsetOTF/CN/SourceHanSansCN-Regular.otf"),
                await fetchFont("https://cdn.jsdelivr.net/gh/adobe-fonts/source-han-sans@release/SubsetOTF/KR/SourceHanSansKR-Regular.otf"),
            ]

            const score = await WebMscore.load('mscz', filedata, fonts)
            console.log(score)

            const title = await score.titleFilenameSafe()
            console.log('score title:', title)
            console.log('number of pages:', await score.npages())

            saveAs(new Blob([await score.saveXml()]), `${title}.musicxml`)
            console.log('generated MusicXML file')

            const n = await score.npages()
            for (let index = 0; index < n; index++) {
                const f = `${title}-${index}.svg`
                const svg = await score.saveSvg(index, true)
                saveAs(new Blob([svg]), f)
                console.log(`generated SVG page ${index}`)
            }

            saveAs(new Blob([await score.saveMxl()]), `${title}.mxl`)
            console.log('generated compressed MusicXML file')

            saveAs(new Blob([await score.saveMidi()]), `${title}.mid`)
            console.log('generated MIDI file')

            const metadata = await score.metadata()
            saveAs(new Blob([JSON.stringify(metadata)]), `metadata.json`)
            console.log('score metadata', metadata)

            score.destroy()
            console.log('destroyed')
        })
    </script>
</body>

</html>
